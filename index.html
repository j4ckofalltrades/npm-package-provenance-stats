<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>npm package provenance stats</title>
    <style>
        :root {
            /* Light theme colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --text-link: #0366d6;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0,0,0,0.1);
            
            /* Package state colors */
            --package-attestations-bg: #d4edda;
            --package-attestations-hover: #c3e6cb;
            --package-without-attestations-bg: #fff3cd;
            --package-without-attestations-hover: #ffeaa7;
            --package-unsupported-bg: #f8d7da;
            --package-unsupported-hover: #f5c6cb;
            --package-outdated-bg: #e9ecef;
            --package-outdated-hover: #dee2e6;
            
            /* Legend text colors */
            --color-green: #0f7b0f;
            --color-grey: #495057;
            --color-yellow: #cc8800;
            --color-pink: #cc0000;
        }

        [data-theme="dark"] {
            /* Dark theme colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d3748;
            --text-primary: #e9ecef;
            --text-secondary: #a0aec0;
            --text-link: #4dabf7;
            --border-color: #4a5568;
            --shadow-color: rgba(0,0,0,0.3);
            
            /* Package state colors for dark theme */
            --package-attestations-bg: #2d5a2d;
            --package-attestations-hover: #3d6a3d;
            --package-without-attestations-bg: #5c4a1a;
            --package-without-attestations-hover: #6c5a2a;
            --package-unsupported-bg: #5c2d2d;
            --package-unsupported-hover: #6c3d3d;
            --package-outdated-bg: #3a3a3a;
            --package-outdated-hover: #4a4a4a;
            
            /* Legend text colors for dark theme */
            --color-green: #4ade80;
            --color-grey: #9ca3af;
            --color-yellow: #fbbf24;
            --color-pink: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            position: relative;
        }

        .header {
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
        }

        .header-controls {
            position: absolute;
            top: 0;
            right: 20px;
            display: flex;
            z-index: 1000;
        }

        .theme-toggle {
            position: relative;
            cursor: pointer;
        }

        .theme-toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-toggle-slider {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 60px;
            height: 32px;
            background: #e9ecef;
            border-radius: 16px;
            padding: 3px;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .theme-toggle-slider::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            transition: transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .theme-toggle-input:checked + .theme-toggle-slider::before {
            transform: translateX(28px);
        }

        .theme-toggle-input:checked + .theme-toggle-slider {
            background: #495057;
        }

        .theme-toggle-input:checked + .theme-toggle-slider::before {
            background: gray;
        }

        .theme-toggle-icon {
            font-size: 20px;
            z-index: 1;
            transition: opacity 0.3s ease;
        }

        .theme-toggle-light {
            opacity: 1;
        }

        .theme-toggle-dark {
            opacity: 0.5;
        }

        .theme-toggle-input:checked + .theme-toggle-slider .theme-toggle-light {
            opacity: 0.5;
        }

        .theme-toggle-input:checked + .theme-toggle-slider .theme-toggle-dark {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 10px;
            }

            .stats {
                font-size: 4em;
            }
        }

        /* Ensure all links maintain consistent color */
        a, a:visited, a:link {
            color: var(--text-link);
        }

        a:hover {
            text-decoration: underline;
        }

        .left-column {
            height: fit-content;
        }

        .stats {
            font-size: 5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .section p {
            margin-bottom: 10px;
            line-height: 1.7;
        }

        .section ul {
            margin-bottom: 15px;
            padding-left: 20px;
            line-height: 1.7;
        }

        .section ul li {
            margin-bottom: 5px;
        }

        .color-green {
            color: var(--color-green);
            font-weight: 500;
        }

        .color-grey {
            color: var(--color-grey);
            font-weight: 500;
        }

        .color-yellow {
            color: var(--color-yellow);
            font-weight: 500;
        }

        .color-pink {
            color: var(--color-pink);
            font-weight: 500;
        }

        .right-column {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--text-link);
        }

        .package-list {
            height: 550px;
            overflow-y: auto;
        }

        .package-item {
            padding: 12px 16px 12px 40px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-decoration: none;
            color: inherit;
            position: relative;
        }

        .package-item:hover {
            text-decoration: none;
        }

        .package-item:hover {
            cursor: pointer;
        }

        .package-with-attestations:hover {
            background-color: var(--package-attestations-hover);
        }

        .package-item[title] {
            position: relative;
        }

        .package-with-attestations {
            background-color: var(--package-attestations-bg);
        }

        .package-without-attestations {
            background-color: var(--package-without-attestations-bg);
        }

        .package-without-attestations:hover {
            background-color: var(--package-without-attestations-hover);
        }

        .package-item.unsupported-publisher {
            background-color: var(--package-unsupported-bg);
        }

        .package-item.unsupported-publisher:hover {
            background-color: var(--package-unsupported-hover);
        }

        .package-item.outdated {
            background-color: var(--package-outdated-bg);
        }

        .package-item.outdated:hover {
            background-color: var(--package-outdated-hover);
        }

        .package-name {
            font-weight: 500;
            font-size: 16px;
        }

        .package-version {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .package-item::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .package-item.unsupported-publisher::before {
            content: 'üö´';
        }

        .package-item.outdated::before {
            content: '‚è∞';
        }

        .package-without-attestations::before {
            content: '‚ûñ';
        }

        .package-with-attestations::before {
            content: 'üîè';
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .footer {
            text-align: center;
            padding: 20px;
            font-size: 16px;
        }

        .footer-content p {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
<div class="container">
        <div class="header">
            <h1>npm package provenance stats</h1>
            <div class="header-controls">
                <label class="theme-toggle" for="theme-toggle" aria-label="Toggle dark mode">
                    <input type="checkbox" id="theme-toggle" class="theme-toggle-input">
                    <span class="theme-toggle-slider">
                        <span class="theme-toggle-icon theme-toggle-light">üåû</span>
                        <span class="theme-toggle-icon theme-toggle-dark">üåô</span>
                    </span>
                </label>
            </div>
        </div>

        <div class="left-column">
            <div class="stats" id="stats">Loading...</div>
            
            <div class="section">
                <h2>What is this list?</h2>
                <p>This site shows the top 500 most-downloaded packages on <a href="https://npmjs.com" target="_blank" >npm</a> showing which have been uploaded with attestations.</p>
                <ul>
                    <li>Green packages with a üîè have attestations for their latest release</li>
                    <li>Gray packages with a ‚è∞ comes from a supported CI/CD provider but were uploaded before attestations were available</li>
                    <li>Yellow packages with a ‚ûñ come from a supported CI/CD provider but have no attestations (yet!)</li>
                    <li>Magenta packages with a üö´ come from an unsupported CI/CD provider</li>
                </ul>
                <p>Refer to the npm docs for more details about <a href="https://docs.npmjs.com/trusted-publishers" target="_blank">Trusted Publishers</a> and <a href="https://docs.npmjs.com/generating-provenance-statements" target="_blank">generating provenance statements</a>.</p>
            </div>
        </div>

        <div class="right-column">
            <label for="searchBox">
                <input type="text" id="searchBox" class="search-box" placeholder="Search packages...">
            </label>
            
            <div id="packageList" class="package-list">
                <div class="loading">Loading package data...</div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div id="lastUpdated">Loading...</div>
    </footer>

    <script>
        let packagesData = [];
        let filteredPackages = [];

        // https://docs.npmjs.com/generating-provenance-statements
        const supportedPublishers = [
            'github.com',
            'gitlab.com',
        ];

        // https://github.blog/security/supply-chain-security/introducing-npm-package-provenance/
        const attestationsEnabledDate = new Date('2023-04-19');

        function isSupportedPublisher(repositoryUrl) {
            if (!repositoryUrl) return false;
            return supportedPublishers.some(publisher => repositoryUrl.toLowerCase().includes(publisher.toLowerCase()));
        }

        function isOutdated(lastUploadedDate) {
            if (!lastUploadedDate) return false;
            const uploadDate = new Date(lastUploadedDate);
            return uploadDate < attestationsEnabledDate;
        }

        function getPackageStateClasses(pkg) {
            const classes = [];
            const hasAttestations = pkg.attestationsUrl !== "";
            
            if (hasAttestations) {
                classes.push('package-with-attestations');
            } else {
                classes.push('package-without-attestations');
                
                if (!isSupportedPublisher(pkg.repositoryUrl)) {
                    classes.push('unsupported-publisher');
                } else if (isOutdated(pkg.lastUploaded)) {
                    classes.push('outdated');
                }
            }
            
            return classes.join(' ');
        }

        async function loadData() {
            try {
                const response = await fetch('data/attestations.json');
                const data = await response.json();
                
                packagesData = data.packages;
                const lastUpdated = new Date(data.lastUpdated).toLocaleDateString('en-US', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                    timeZone: 'UTC',
                    timeZoneName: 'short'
                });
                document.getElementById('lastUpdated').innerHTML =
                    `<div class="footer-content">
                        <p>Last updated ${lastUpdated}. (Updated daily.)</p>
                        <p>Inspired by <a href="https://trailofbits.github.io/are-we-pep740-yet" target="_blank">Are we PEP 740 yet?</a>. Source on <a href="https://github.com/j4ckofalltrades/npm-package-provenance-stats" target="_blank">GitHub</a>.</p>
                     </div>
                     `;
                
                filteredPackages = [...packagesData];

                // Calculate statistics
                const total = packagesData.length;
                const withAttestations = packagesData.filter(pkg => pkg.attestationsUrl !== "").length;
                const withoutAttestations = packagesData.filter(pkg => {
                    const hasAttestations = pkg.attestationsUrl !== "";
                    return !hasAttestations && isSupportedPublisher(pkg.repositoryUrl) && !isOutdated(pkg.lastUploaded);
                }).length;
                const unsupportedProvider = packagesData.filter(pkg => {
                    const hasAttestations = pkg.attestationsUrl !== "";
                    return !hasAttestations && !isSupportedPublisher(pkg.repositoryUrl);
                }).length;
                const outdated = packagesData.filter(pkg => {
                    const hasAttestations = pkg.attestationsUrl !== "";
                    return !hasAttestations && isSupportedPublisher(pkg.repositoryUrl) && isOutdated(pkg.lastUploaded);
                }).length;

                // Calculate percentages
                const attestationsPercent = Math.round((withAttestations / total) * 100);
                const withoutAttestationsPercent = Math.round((withoutAttestations / total) * 100);
                const unsupportedProviderPercent = Math.round((unsupportedProvider / total) * 100);
                const outdatedPercent = Math.round((outdated / total) * 100);

                document.getElementById('stats').innerHTML = `${withAttestations} / ${total}`;
                
                // Update legend with percentages
                document.querySelector('.section ul').innerHTML = `
                    <li><span class="color-green">Green</span> packages (${attestationsPercent}%) with a üîè have attestations for their latest release</li>
                    <li><span class="color-grey">Grey</span> packages (${outdatedPercent}%) with a ‚è∞ come from a supported CI/CD provider but were uploaded before attestations were available</li>
                    <li><span class="color-yellow">Yellow</span> packages (${withoutAttestationsPercent}%) with a ‚ûñ come from a supported CI/CD provider but have no attestations (yet!)</li>
                    <li><span class="color-pink">Pink</span> packages (${unsupportedProviderPercent}%) with a üö´ come from an unsupported CI/CD provider</li>
                `;

                renderPackages();
            } catch (error) {
                document.getElementById('packageList').innerHTML = '<div class="loading">Error loading data</div>';
                document.getElementById('lastUpdated').textContent = 'Error loading timestamp';
                console.error('Error loading data:', error);
            }
        }

        function renderPackages() {
            const container = document.getElementById('packageList');
            
            if (filteredPackages.length === 0) {
                container.innerHTML = '<div class="loading">No packages found</div>';
                return;
            }

            container.innerHTML = filteredPackages.map(pkg => {
                const hasAttestations = pkg.attestationsUrl !== "";
                const className = getPackageStateClasses(pkg);
                
                let tooltip;
                if (hasAttestations) {
                    tooltip = 'This package provides attestations.';
                } else if (className.includes('unsupported-publisher')) {
                    tooltip = 'This package does not provide attestations and is from an unsupported publisher.';
                } else if (className.includes('outdated')) {
                    tooltip = 'This package does not provide attestations and was last uploaded before attestations were available.';
                } else {
                    tooltip = 'This package does not provide attestations (yet!).';
                }

                const releaseDate = pkg.lastUploaded ? new Date(pkg.lastUploaded).toISOString().split('T')[0] : '';
                
                return `
                    <a href="https://npmjs.com/package/${pkg.package}" class="package-item ${className}" target="_blank" title="${tooltip}">
                        <div>
                            <div class="package-name">${pkg.package}</div>
                            <div class="package-version">v${pkg.version} ${releaseDate ? `released on ${releaseDate}` : ''}</div>
                        </div>
                    </a>
                `;
            }).join('');
        }

        document.getElementById('searchBox').addEventListener('input', (e) => {
            const query = e.target.value

            if (!query.trim()) {
                filteredPackages = [...packagesData];
            } else {
                const lowercaseQuery = query.toLowerCase();
                filteredPackages = packagesData.filter(pkg =>
                    pkg.package.toLowerCase().includes(lowercaseQuery)
                );
            }

            renderPackages();
        });

        loadData();

        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        // Check for saved theme preference or default to 'light' mode
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            body.setAttribute('data-theme', currentTheme);
            if (currentTheme === 'dark') {
                themeToggle.checked = true;
            }
        } else {
            // Check system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                body.setAttribute('data-theme', 'dark');
                themeToggle.checked = true;
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        }

        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    body.setAttribute('data-theme', 'dark');
                    themeToggle.checked = true;
                } else {
                    body.setAttribute('data-theme', 'light');
                    themeToggle.checked = false;
                }
            }
        });
    </script>
</body>
</html>